<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>夕方の市街地3Dビュー</title>
    <style>
        body { 
            margin: 0;
            overflow: hidden;
        }
        canvas { 
            display: block;
        }
        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            color: white;
            font-family: Arial, sans-serif;
            pointer-events: none;
        }
        #controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            font-family: Arial, sans-serif;
            background-color: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="info">夕方の市街地 - 西陽が差す100m四方の空間</div>
    <div id="controls">
        移動: WASD または 矢印キー | マウスでカメラ回転 | スペースで上昇 | Shift で下降
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // シーンのセットアップ
        const scene = new THREE.Scene();
        
        // 夕方の雰囲気の背景色
        scene.background = new THREE.Color(0xffa07a); // 夕日の色
        scene.fog = new THREE.FogExp2(0xffa07a, 0.002);
        
        // カメラのセットアップ
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(20, 2, 20); // 道路から少し上の視点
        camera.lookAt(0, 0, 0);
        
        // レンダラーのセットアップ
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true; // 影を有効化
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);
        
        // 照明のセットアップ - 西陽を再現
        const ambientLight = new THREE.AmbientLight(0x404040, 0.5); // 環境光
        scene.add(ambientLight);
        
        // 西陽（方向性のある光）
        const sunLight = new THREE.DirectionalLight(0xff7e47, 1);
        sunLight.position.set(-50, 50, -10); // 西から差し込む太陽
        sunLight.castShadow = true;
        sunLight.shadow.mapSize.width = 2048;
        sunLight.shadow.mapSize.height = 2048;
        sunLight.shadow.camera.near = 0.5;
        sunLight.shadow.camera.far = 200;
        sunLight.shadow.camera.left = -100;
        sunLight.shadow.camera.right = 100;
        sunLight.shadow.camera.top = 100;
        sunLight.shadow.camera.bottom = -100;
        scene.add(sunLight);
        
        // 道路用テクスチャ
        const roadTexture = new THREE.TextureLoader().load('https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/textures/brick_diffuse.jpg');
        roadTexture.wrapS = THREE.RepeatWrapping;
        roadTexture.wrapT = THREE.RepeatWrapping;
        roadTexture.repeat.set(10, 10);
        
        // 歩道用テクスチャ
        const sidewalkTexture = new THREE.TextureLoader().load('https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/textures/hardwood2_diffuse.jpg');
        sidewalkTexture.wrapS = THREE.RepeatWrapping;
        sidewalkTexture.wrapT = THREE.RepeatWrapping;
        sidewalkTexture.repeat.set(20, 20);
        
        // 建物用テクスチャ
        const buildingTexture1 = new THREE.TextureLoader().load('https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/textures/brick_diffuse.jpg');
        const buildingTexture2 = new THREE.TextureLoader().load('https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/textures/hardwood2_diffuse.jpg');
        
        // 地面（100m x 100m）
        const groundGeometry = new THREE.PlaneGeometry(100, 100);
        const groundMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x1a1a1a,
            roughness: 0.8,
            metalness: 0.2
        });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);
        
        // 道路を作成（十字路）
        function createRoads() {
            // 南北方向の道路
            const nsRoadGeometry = new THREE.PlaneGeometry(12, 100);
            const nsRoadMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x333333,
                map: roadTexture,
                roughness: 0.7
            });
            const nsRoad = new THREE.Mesh(nsRoadGeometry, nsRoadMaterial);
            nsRoad.rotation.x = -Math.PI / 2;
            nsRoad.position.y = 0.01; // 地面のすぐ上
            nsRoad.receiveShadow = true;
            scene.add(nsRoad);
            
            // 東西方向の道路
            const ewRoadGeometry = new THREE.PlaneGeometry(100, 12);
            const ewRoadMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x333333,
                map: roadTexture,
                roughness: 0.7
            });
            const ewRoad = new THREE.Mesh(ewRoadGeometry, ewRoadMaterial);
            ewRoad.rotation.x = -Math.PI / 2;
            ewRoad.position.y = 0.01;
            ewRoad.receiveShadow = true;
            scene.add(ewRoad);
            
            // 南北方向の歩道（左側）
            const nsSidewalk1 = new THREE.Mesh(
                new THREE.PlaneGeometry(3, 100),
                new THREE.MeshStandardMaterial({ 
                    color: 0x999999,
                    map: sidewalkTexture,
                    roughness: 0.8
                })
            );
            nsSidewalk1.rotation.x = -Math.PI / 2;
            nsSidewalk1.position.set(-7.5, 0.05, 0);
            nsSidewalk1.receiveShadow = true;
            scene.add(nsSidewalk1);
            
            // 南北方向の歩道（右側）
            const nsSidewalk2 = nsSidewalk1.clone();
            nsSidewalk2.position.set(7.5, 0.05, 0);
            scene.add(nsSidewalk2);
            
            // 東西方向の歩道（上側）
            const ewSidewalk1 = new THREE.Mesh(
                new THREE.PlaneGeometry(100, 3),
                new THREE.MeshStandardMaterial({ 
                    color: 0x999999,
                    map: sidewalkTexture,
                    roughness: 0.8
                })
            );
            ewSidewalk1.rotation.x = -Math.PI / 2;
            ewSidewalk1.position.set(0, 0.05, -7.5);
            ewSidewalk1.receiveShadow = true;
            scene.add(ewSidewalk1);
            
            // 東西方向の歩道（下側）
            const ewSidewalk2 = ewSidewalk1.clone();
            ewSidewalk2.position.set(0, 0.05, 7.5);
            scene.add(ewSidewalk2);
            
            // 横断歩道を作成
            createCrosswalk(0, 10, 0, Math.PI / 2);
            createCrosswalk(0, -10, 0, Math.PI / 2);
            createCrosswalk(10, 0, 0, 0);
            createCrosswalk(-10, 0, 0, 0);
        }
        
        // 横断歩道を作成する関数
        function createCrosswalk(x, z, y, rotation) {
            const crosswalkGeometry = new THREE.PlaneGeometry(12, 3);
            const crosswalkMaterial = new THREE.MeshStandardMaterial({
                color: 0xffffff,
                roughness: 0.7,
                metalness: 0.1,
            });
            
            // 白いストライプを作成
            for (let i = 0; i < 6; i++) {
                const stripe = new THREE.Mesh(
                    new THREE.PlaneGeometry(1, 3),
                    crosswalkMaterial
                );
                stripe.rotation.x = -Math.PI / 2;
                stripe.position.set(x - 2.5 + i, 0.02, z);
                if (rotation) {
                    stripe.rotation.z = rotation;
                    stripe.position.set(x, 0.02, z - 2.5 + i);
                }
                stripe.receiveShadow = true;
                scene.add(stripe);
            }
        }
        
        // 建物を作成する関数
        function createBuilding(x, z, width, depth, height, textureType = 1) {
            const geometry = new THREE.BoxGeometry(width, height, depth);
            
            // 建物タイプに応じたテクスチャと色を選択
            let material;
            if (textureType === 1) {
                material = new THREE.MeshStandardMaterial({
                    color: 0xdddddd,
                    map: buildingTexture1,
                    roughness: 0.7,
                    metalness: 0.2
                });
            } else if (textureType === 2) {
                material = new THREE.MeshStandardMaterial({
                    color: 0xaaaaaa,
                    map: buildingTexture2,
                    roughness: 0.6,
                    metalness: 0.3
                });
            } else {
                material = new THREE.MeshStandardMaterial({
                    color: 0x888888,
                    roughness: 0.5,
                    metalness: 0.4
                });
            }
            
            const building = new THREE.Mesh(geometry, material);
            building.position.set(x, height / 2, z);
            building.castShadow = true;
            building.receiveShadow = true;
            scene.add(building);
            
            // ビルの窓を作成
            createWindows(building, width, height, depth);
            
            return building;
        }
        
        // 窓を作成する関数
        function createWindows(building, width, height, depth) {
            const windowMaterial = new THREE.MeshStandardMaterial({
                color: 0xffffcc, // 明かりのついた窓の色
                emissive: 0x555555,
                roughness: 0.1,
                metalness: 0.8
            });
            
            // 建物の各面に窓を作成
            const sides = [
                { dir: 'front', x: 0, y: 0, z: depth / 2 + 0.01, rotY: 0 },
                { dir: 'back', x: 0, y: 0, z: -depth / 2 - 0.01, rotY: Math.PI },
                { dir: 'left', x: -width / 2 - 0.01, y: 0, z: 0, rotY: -Math.PI / 2 },
                { dir: 'right', x: width / 2 + 0.01, y: 0, z: 0, rotY: Math.PI / 2 }
            ];
            
            sides.forEach(side => {
                // 窓の行数と列数を計算
                const rows = Math.floor(height / 3);
                const cols = side.dir === 'front' || side.dir === 'back' 
                    ? Math.floor(width / 2) 
                    : Math.floor(depth / 2);
                
                for (let row = 0; row < rows; row++) {
                    for (let col = 0; col < cols; col++) {
                        // ランダムに一部の窓だけ表示（夜のオフィスビルのように）
                        if (Math.random() > 0.3) {
                            const windowGeometry = new THREE.PlaneGeometry(1, 1);
                            const windowMesh = new THREE.Mesh(windowGeometry, windowMaterial);
                            
                            // 窓の位置を計算
                            let xPos = side.dir === 'front' || side.dir === 'back'
                                ? -width / 2 + 1 + col * 2
                                : 0;
                            let zPos = side.dir === 'left' || side.dir === 'right'
                                ? -depth / 2 + 1 + col * 2
                                : side.z;
                            
                            windowMesh.position.set(
                                side.x + xPos,
                                1 + row * 3,
                                side.z + zPos
                            );
                            
                            // 窓を建物の面に合わせて回転
                            windowMesh.rotation.y = side.rotY;
                            
                            building.add(windowMesh);
                        }
                    }
                }
            });
        }
        
        // 街灯を作成する関数
        function createStreetLight(x, z) {
            const poleGeometry = new THREE.CylinderGeometry(0.2, 0.2, 6, 8);
            const poleMaterial = new THREE.MeshStandardMaterial({
                color: 0x333333,
                roughness: 0.8,
                metalness: 0.5
            });
            const pole = new THREE.Mesh(poleGeometry, poleMaterial);
            pole.position.set(x, 3, z);
            pole.castShadow = true;
            pole.receiveShadow = true;
            scene.add(pole);
            
            // 照明部分
            const lightGeometry = new THREE.SphereGeometry(0.5, 16, 16);
            const lightMaterial = new THREE.MeshStandardMaterial({
                color: 0xffffcc,
                emissive: 0xffffcc,
                emissiveIntensity: 1,
                roughness: 0.1,
                metalness: 0.8
            });
            const lightBulb = new THREE.Mesh(lightGeometry, lightMaterial);
            lightBulb.position.set(x, 6, z);
            scene.add(lightBulb);
            
            // ポイントライト
            const pointLight = new THREE.PointLight(0xffffcc, 1, 15);
            pointLight.position.set(x, 6, z);
            scene.add(pointLight);
        }
        
        // 信号機を作成する関数
        function createTrafficLight(x, z, rotation = 0) {
            // 支柱
            const poleGeometry = new THREE.CylinderGeometry(0.2, 0.2, 5, 8);
            const poleMaterial = new THREE.MeshStandardMaterial({
                color: 0x333333,
                roughness: 0.8,
                metalness: 0.5
            });
            const pole = new THREE.Mesh(poleGeometry, poleMaterial);
            pole.position.set(x, 2.5, z);
            pole.castShadow = true;
            pole.receiveShadow = true;
            scene.add(pole);
            
            // 信号機本体
            const bodyGeometry = new THREE.BoxGeometry(0.8, 2, 0.5);
            const bodyMaterial = new THREE.MeshStandardMaterial({
                color: 0x222222,
                roughness: 0.8,
                metalness: 0.5
            });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.set(x, 5, z);
            body.rotation.y = rotation;
            body.castShadow = true;
            body.receiveShadow = true;
            scene.add(body);
            
            // 信号の光
            const colors = [0xff0000, 0xffff00, 0x00ff00]; // 赤、黄、緑
            
            for (let i = 0; i < 3; i++) {
                const lightGeometry = new THREE.CircleGeometry(0.15, 16);
                const lightMaterial = new THREE.MeshStandardMaterial({
                    color: colors[i],
                    emissive: colors[i],
                    emissiveIntensity: i === 0 ? 1 : 0.2 // 赤信号を点灯
                });
                const light = new THREE.Mesh(lightGeometry, lightMaterial);
                
                // 信号機の前面に配置
                const offset = rotation === 0 ? 0.26 : rotation === Math.PI ? -0.26 : 0;
                const zOffset = rotation === Math.PI / 2 ? -0.26 : rotation === -Math.PI / 2 ? 0.26 : 0;
                
                light.position.set(
                    x + offset,
                    5.7 - i * 0.7,
                    z + zOffset
                );
                light.rotation.y = rotation;
                scene.add(light);
            }
        }
        
        // 街路樹を作成する関数
        function createTree(x, z) {
            // 幹
            const trunkGeometry = new THREE.CylinderGeometry(0.3, 0.4, 2, 8);
            const trunkMaterial = new THREE.MeshStandardMaterial({
                color: 0x8B4513,
                roughness: 0.9,
                metalness: 0.1
            });
            const trunk = new THREE.Mesh(trunkGeometry, trunkMaterial);
            trunk.position.set(x, 1, z);
            trunk.castShadow = true;
            trunk.receiveShadow = true;
            scene.add(trunk);
            
            // 葉
            const leavesGeometry = new THREE.SphereGeometry(1.5, 16, 16);
            const leavesMaterial = new THREE.MeshStandardMaterial({
                color: 0x228B22,
                roughness: 0.8,
                metalness: 0.1
            });
            const leaves = new THREE.Mesh(leavesGeometry, leavesMaterial);
            leaves.position.set(x, 3, z);
            leaves.castShadow = true;
            leaves.receiveShadow = true;
            scene.add(leaves);
        }
        
        // 車を作成する関数
        function createCar(x, z, color = 0xff0000, direction = 0) {
            // 車体
            const bodyGeometry = new THREE.BoxGeometry(2, 1, 4);
            const bodyMaterial = new THREE.MeshStandardMaterial({
                color: color,
                roughness: 0.5,
                metalness: 0.7
            });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.set(x, 0.6, z);
            body.castShadow = true;
            body.receiveShadow = true;
            scene.add(body);
            
            // 車の上部
            const topGeometry = new THREE.BoxGeometry(1.8, 0.8, 2);
            const topMaterial = new THREE.MeshStandardMaterial({
                color: color,
                roughness: 0.5,
                metalness: 0.7
            });
            const top = new THREE.Mesh(topGeometry, topMaterial);
            top.position.set(x, 1.5, z - 0.5);
            top.castShadow = true;
            top.receiveShadow = true;
            scene.add(top);
            
            // ヘッドライト
            const headlightGeometry = new THREE.SphereGeometry(0.2, 16, 16);
            const headlightMaterial = new THREE.MeshStandardMaterial({
                color: 0xffffcc,
                emissive: 0xffffcc,
                emissiveIntensity: 1,
                roughness: 0.1,
                metalness: 0.8
            });
            
            const headlight1 = new THREE.Mesh(headlightGeometry, headlightMaterial);
            const headlight2 = new THREE.Mesh(headlightGeometry, headlightMaterial);
            
            // 方向に応じてヘッドライトの位置を調整
            if (direction === 0) { // 北向き
                headlight1.position.set(x - 0.6, 0.6, z + 2);
                headlight2.position.set(x + 0.6, 0.6, z + 2);
                body.rotation.y = 0;
                top.rotation.y = 0;
            } else if (direction === 1) { // 東向き
                headlight1.position.set(x + 2, 0.6, z - 0.6);
                headlight2.position.set(x + 2, 0.6, z + 0.6);
                body.rotation.y = Math.PI / 2;
                top.rotation.y = Math.PI / 2;
            } else if (direction === 2) { // 南向き
                headlight1.position.set(x - 0.6, 0.6, z - 2);
                headlight2.position.set(x + 0.6, 0.6, z - 2);
                body.rotation.y = Math.PI;
                top.rotation.y = Math.PI;
            } else { // 西向き
                headlight1.position.set(x - 2, 0.6, z - 0.6);
                headlight2.position.set(x - 2, 0.6, z + 0.6);
                body.rotation.y = -Math.PI / 2;
                top.rotation.y = -Math.PI / 2;
            }
            
            scene.add(headlight1);
            scene.add(headlight2);
            
            // スポットライト（ヘッドライト効果）
            if (direction === 0) { // 北向き
                const spotlight = new THREE.SpotLight(0xffffcc, 1);
                spotlight.position.set(x, 0.6, z + 2);
                spotlight.target.position.set(x, 0, z + 10);
                spotlight.angle = Math.PI / 8;
                spotlight.penumbra = 0.2;
                spotlight.distance = 20;
                spotlight.castShadow = true;
                scene.add(spotlight);
                scene.add(spotlight.target);
            }
            
            return { body, top, headlight1, headlight2 };
        }
        
        // 市街地を配置
        function setupCity() {
            // 道路を作成
            createRoads();
            
            // 各象限にビルを配置
            // 第1象限（右上）
            createBuilding(20, -20, 15, 15, 25, 1);
            createBuilding(35, -15, 8, 10, 15, 2);
            createBuilding(20, -40, 12, 12, 20, 3);
            createBuilding(40, -35, 10, 10, 18, 1);
            
            // 第2象限（左上）
            createBuilding(-20, -20, 15, 15, 22, 2);
            createBuilding(-35, -15, 10, 8, 12, 3);
            createBuilding(-20, -40, 12, 12, 18, 1);
            createBuilding(-40, -35, 8, 10, 16, 2);
            
            // 第3象限（左下）
            createBuilding(-20, 20, 15, 15, 20, 3);
            createBuilding(-35, 15, 8, 10, 14, 1);
            createBuilding(-20, 40, 12, 12, 22, 2);
            createBuilding(-40, 35, 10, 8, 16, 3);
            
            // 第4象限（右下）
            createBuilding(20, 20, 15, 15, 24, 1);
            createBuilding(35, 15, 10, 8, 16, 2);
            createBuilding(20, 40, 12, 12, 18, 3);
            createBuilding(40, 35, 8, 10, 14, 1);
            
            // 街灯を配置
            createStreetLight(-10, -15);
            createStreetLight(10, -15);
            createStreetLight(-10, 15);
            createStreetLight(10, 15);
            createStreetLight(-15, -10);
            createStreetLight(-15, 10);
            createStreetLight(15, -10);
            createStreetLight(15, 10);
            
            // 信号機を配置
            createTrafficLight(-5, -10, Math.PI / 2);
            createTrafficLight(5, -10, -Math.PI / 2);
            createTrafficLight(-5, 10, Math.PI / 2);
            createTrafficLight(5, 10, -Math.PI / 2);
            createTrafficLight(-10, -5, 0);
            createTrafficLight(-10, 5, Math.PI);
            createTrafficLight(10, -5, 0);
            createTrafficLight(10, 5, Math.PI);
            
            // 街路樹を配置
            for (let i = -40; i <= 40; i += 10) {
                if (Math.abs(i) > 10) { // 交差点付近は避ける
                    createTree(-9, i);
                    createTree(9, i);
                    createTree(i, -9);
                    createTree(i, 9);
                }
            }
            
            // 車を配置
            createCar(3, 20, 0xff0000, 0); // 赤い車、北向き
            createCar(-3, -20, 0x0000ff, 2); // 青い車、南向き
            createCar(-20, -3, 0x00ff00, 1); // 緑の車、東向き
            createCar(20, 3, 0xffff00, 3); // 黄色い車、西向き
            createCar(3, 30, 0xff00ff, 0); // ピンクの車、北向き
            createCar(-3, -30, 0x00ffff, 2); // シアンの車、南向き
        }
        
        // 市街地をセットアップ
        setupCity();
        
        // キー入力の状態
        const keys = {
            w: false,
            a: false,
            s: false,
            d: false,
            space: false,
            shift: false,
            up: false,
            down: false,
            left: false,
            right: false
        };
        
        // キーダウンイベント
        document.addEventListener('keydown', (event) => {
            switch (event.key.toLowerCase()) {
                case 'w':
                case 'arrowup':
                    keys.w = true;
                    keys.up = true;
                    break;
                case 'a':
                case 'arrowleft':
                    keys.a = true;
                    keys.left = true;
                    break;
                case 's':
                case 'arrowdown':
                    keys.s = true;
                    keys.down = true;
                    break;
                case 'd':
                case 'arrowright':
                    keys.d = true;
                    keys.right = true;
                    break;
                case ' ':
                    keys.space = true;
                    break;
                case 'shift':
                    keys.shift = false;
                    break;
            }
        });.shift = true;
                    break;
            }
        });
        
        // キーアップイベント
        document.addEventListener('keyup', (event) => {
            switch (event.key.toLowerCase()) {
                case 'w':
                case 'arrowup':
                    keys.w = false;
                    keys.up = false;
                    break;
                case 'a':
                case 'arrowleft':
                    keys.a = false;
                    keys.left = false;
                    break;
                case 's':
                case 'arrowdown':
                    keys.s = false;
                    keys.down = false;
                    break;
                case 'd':
                case 'arrowright':
                    keys.d = false;
                    keys.right = false;
                    break;
                case ' ':
                    keys.space = false;
                    break;
                case 'shift':
                    keys
