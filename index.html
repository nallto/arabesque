<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リアルタイム顔特徴点検出</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.dom.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .container {
            position: relative;
            margin-bottom: 20px;
        }
        
        canvas {
            border: 3px solid #333;
            border-radius: 10px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .status {
            margin-top: 10px;
            font-size: 16px;
            color: #333;
        }
    </style>
</head>
<body>
    <h1>リアルタイム顔特徴点検出</h1>
    <div id="canvas-container" class="container"></div>
    <div class="controls">
        <button id="startButton">カメラ開始</button>
        <button id="stopButton" disabled>停止</button>
    </div>
    <div id="status" class="status">準備完了</div>
    
    <script>
        let capture;
        let canvas;
        let isRunning = false;
        let facePoints = [];
        const numPoints = 68; // 検出する特徴点の数
        
        // p5.jsのセットアップ
        function setup() {
            // キャンバスの作成
            canvas = createCanvas(640, 480);
            canvas.parent('canvas-container');
            
            // ボタンのイベントリスナー設定
            document.getElementById('startButton').addEventListener('click', startCamera);
            document.getElementById('stopButton').addEventListener('click', stopCamera);
            
            // 初期状態ではカメラは停止
            noLoop();
        }
        
        // カメラの開始
        function startCamera() {
            if (!isRunning) {
                // カメラのセットアップ
                capture = createCapture(VIDEO);
                capture.size(width, height);
                capture.hide(); // プレビューを非表示
                
                // ステータス更新
                document.getElementById('status').textContent = 'カメラ起動中...';
                
                // 特徴点の初期化（デモ用にランダムな位置）
                initializeDemoPoints();
                
                // 検出開始
                isRunning = true;
                loop();
                
                // ボタンの状態更新
                document.getElementById('startButton').disabled = true;
                document.getElementById('stopButton').disabled = false;
                document.getElementById('status').textContent = '顔特徴点検出実行中（デモモード）';
            }
        }
        
        // カメラの停止
        function stopCamera() {
            if (isRunning) {
                // カメラの停止
                if (capture) {
                    capture.remove();
                    capture = null;
                }
                
                // 検出停止
                isRunning = false;
                noLoop();
                
                // キャンバスのクリア
                clear();
                
                // ボタンの状態更新
                document.getElementById('startButton').disabled = false;
                document.getElementById('stopButton').disabled = true;
                document.getElementById('status').textContent = '停止しました';
            }
        }
        
        // デモ用の特徴点の初期化（顔の形に似せたランダムな位置）
        function initializeDemoPoints() {
            facePoints = [];
            
            // 顔の輪郭（17点）
            for (let i = 0; i < 17; i++) {
                const angle = map(i, 0, 16, PI, 0);
                const x = width / 2 + cos(angle) * 180;
                const y = height / 2 + sin(angle) * 200;
                facePoints.push(createVector(x, y));
            }
            
            // 左眉（5点）
            for (let i = 0; i < 5; i++) {
                const x = width / 2 - 80 + i * 25;
                const y = height / 2 - 80;
                facePoints.push(createVector(x, y));
            }
            
            // 右眉（5点）
            for (let i = 0; i < 5; i++) {
                const x = width / 2 + 80 - i * 25;
                const y = height / 2 - 80;
                facePoints.push(createVector(x, y));
            }
            
            // 鼻筋（4点）
            for (let i = 0; i < 4; i++) {
                const x = width / 2;
                const y = height / 2 - 50 + i * 25;
                facePoints.push(createVector(x, y));
            }
            
            // 鼻下部（5点）
            for (let i = 0; i < 5; i++) {
                const x = width / 2 - 20 + i * 10;
                const y = height / 2 + 25;
                facePoints.push(createVector(x, y));
            }
            
            // 左目（6点）
            for (let i = 0; i < 6; i++) {
                const angle = map(i, 0, 6, 0, TWO_PI);
                const x = width / 2 - 60 + cos(angle) * 25;
                const y = height / 2 - 50 + sin(angle) * 15;
                facePoints.push(createVector(x, y));
            }
            
            // 右目（6点）
            for (let i = 0; i < 6; i++) {
                const angle = map(i, 0, 6, 0, TWO_PI);
                const x = width / 2 + 60 + cos(angle) * 25;
                const y = height / 2 - 50 + sin(angle) * 15;
                facePoints.push(createVector(x, y));
            }
            
            // 外唇（12点）
            for (let i = 0; i < 12; i++) {
                const angle = map(i, 0, 12, 0, TWO_PI);
                const x = width / 2 + cos(angle) * 50;
                const y = height / 2 + 70 + sin(angle) * 30;
                facePoints.push(createVector(x, y));
            }
            
            // 内唇（8点）
            for (let i = 0; i < 8; i++) {
                const angle = map(i, 0, 8, 0, TWO_PI);
                const x = width / 2 + cos(angle) * 30;
                const y = height / 2 + 70 + sin(angle) * 15;
                facePoints.push(createVector(x, y));
            }
        }
        
        // アニメーションのための特徴点更新
        function updateDemoPoints() {
            // 顔の中心点
            const centerX = width / 2;
            const centerY = height / 2;
            
            // カメラの画像から動きを検出（簡易的なモーション検出）
            let avgBrightness = 0;
            if (capture) {
                capture.loadPixels();
                if (capture.pixels.length > 0) {
                    const sample = 10; // サンプリングレート
                    for (let y = 0; y < height; y += sample) {
                        for (let x = 0; x < width; x += sample) {
                            const i = (y * width + x) * 4;
                            avgBrightness += (capture.pixels[i] + capture.pixels[i+1] + capture.pixels[i+2]) / 3;
                        }
                    }
                    avgBrightness /= (width * height / (sample * sample));
                }
            }
            
            // 動きに応じて特徴点を少しランダムに動かす
            const moveScale = map(noise(frameCount * 0.01), 0, 1, 0.5, 2);
            for (let i = 0; i < facePoints.length; i++) {
                const point = facePoints[i];
                const angle = noise(i, frameCount * 0.01) * TWO_PI;
                const dist = noise(i + 100, frameCount * 0.01) * 3 * moveScale;
                
                // 元の位置からランダムに動かす
                point.x += cos(angle) * dist;
                point.y += sin(angle) * dist;
                
                // 元の顔の形状に徐々に戻す
                const origX = facePoints[i].x;
                const origY = facePoints[i].y;
                point.x = lerp(point.x, origX, 0.1);
                point.y = lerp(point.y, origY, 0.1);
            }
        }
        
        // 描画処理
        function draw() {
            background(240);
            
            if (isRunning && capture) {
                // カメラの映像を描画
                push();
                translate(width, 0);
                scale(-1, 1); // 鏡像反転
                image(capture, 0, 0, width, height);
                pop();
                
                // デモ用の特徴点を更新
                updateDemoPoints();
                
                // 特徴点の描画
                drawFacialFeatures();
            }
        }
        
        // 顔の特徴点とその接続線を描画
        function drawFacialFeatures() {
            if (facePoints.length === 0) return;
            
            // 顔の輪郭
            stroke(51, 153, 255);
            strokeWeight(2);
            noFill();
            beginShape();
            for (let i = 0; i < 17; i++) {
                const point = facePoints[i];
                vertex(point.x, point.y);
            }
            endShape();
            
            // 左眉
            beginShape();
            for (let i = 17; i < 22; i++) {
                const point = facePoints[i];
                vertex(point.x, point.y);
            }
            endShape();
            
            // 右眉
            beginShape();
            for (let i = 22; i < 27; i++) {
                const point = facePoints[i];
                vertex(point.x, point.y);
            }
            endShape();
            
            // 鼻筋
            beginShape();
            for (let i = 27; i < 31; i++) {
                const point = facePoints[i];
                vertex(point.x, point.y);
            }
            endShape();
            
            // 鼻下部
            beginShape();
            for (let i = 31; i < 36; i++) {
                const point = facePoints[i];
                vertex(point.x, point.y);
            }
            endShape();
            
            // 左目
            beginShape();
            for (let i = 36; i < 42; i++) {
                const point = facePoints[i];
                vertex(point.x, point.y);
            }
            endShape(CLOSE);
            
            // 右目
            beginShape();
            for (let i = 42; i < 48; i++) {
                const point = facePoints[i];
                vertex(point.x, point.y);
            }
            endShape(CLOSE);
            
            // 外唇
            beginShape();
            for (let i = 48; i < 60; i++) {
                const point = facePoints[i];
                vertex(point.x, point.y);
            }
            endShape(CLOSE);
            
            // 内唇
            beginShape();
            for (let i = 60; i < 68; i++) {
                const point = facePoints[i];
                vertex(point.x, point.y);
            }
            endShape(CLOSE);
            
            // すべての特徴点を描画
            fill(255, 0, 0);
            noStroke();
            for (let i = 0; i < facePoints.length; i++) {
                const point = facePoints[i];
                ellipse(point.x, point.y, 4, 4);
            }
        }
    </script>
</body>
</html>
